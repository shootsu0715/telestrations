<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Theç”»ä¼¯</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=Hachi+Maru+Pop&display=swap" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
<style>
/* â”€â”€ ãƒªã‚»ãƒƒãƒˆ & ã‚«ãƒ©ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  â”€â”€ */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#faf7f2;--card:#faf7f2;--border:#e8e2d9;--soft:#f5f0e8;
  --primary:#8b6aae;--primary-light:#ece4f5;
  --accent:#f5a623;--accent-light:#fff4e0;
  --danger:#e8636a;--success:#5cb87a;
  --text:#3d3535;--text-l:#8a807a;--text-m:#b5ada6;
  --r:16px;--sh:0 2px 12px rgba(0,0,0,0.04)
}
body{font-family:'Zen Maru Gothic','Hiragino Maru Gothic Pro','BIZ UDGothic','Rounded Mplus 1c',sans-serif;min-height:100vh;background:var(--bg);color:var(--text);display:flex;justify-content:center;padding:16px;overflow-x:hidden}
.app{width:100%;max-width:640px;margin:0 auto;position:relative;overflow-x:hidden}
.app>*:not(.bg-sticker){position:relative;z-index:1}
.screen{display:none;animation:slideUp .4s ease-out}.screen.active{display:flex;flex-direction:column;align-items:center}

/* â”€â”€ ã‚«ãƒ¼ãƒ‰ & åŸºæœ¬è¦ç´  â”€â”€ */
.card{background:var(--card);border:1.5px solid var(--border);border-radius:20px;padding:28px;width:100%;box-shadow:var(--sh)}
h1{font-size:36px;font-weight:900;color:var(--primary);text-align:center;letter-spacing:2px}
h2{font-size:24px;font-weight:900;text-align:center;margin-bottom:20px;color:var(--text)}
.sub{font-family:'Hachi Maru Pop',cursive;color:var(--text-m);font-size:14px;text-align:center}

/* â”€â”€ ãƒœã‚¿ãƒ³ â”€â”€ */
.btn{padding:14px 32px;border-radius:var(--r);border:none;font-size:18px;font-weight:700;cursor:pointer;font-family:'Zen Maru Gothic',sans-serif;transition:transform .12s;width:100%;display:inline-flex;justify-content:center;align-items:center;gap:8px}
.btn:active{transform:scale(.97)}.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-p{background:var(--primary);color:#fff;box-shadow:0 4px 12px rgba(139,106,174,0.2)}
.btn-s{background:linear-gradient(135deg,#a29bfe,#8b6aae);color:#fff}
.btn-ok{background:var(--success);color:#fff}
.btn-g{background:var(--soft);color:var(--text-l);border:1.5px solid var(--border)}

/* â”€â”€ å…¥åŠ› â”€â”€ */
.inp{padding:14px 18px;border-radius:14px;border:2px solid var(--border);font-size:18px;outline:none;width:100%;font-family:'Zen Maru Gothic',sans-serif;font-weight:700;background:var(--soft);color:var(--text)}
.inp:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(139,106,174,0.15)}
.inp::placeholder{font-weight:400;color:var(--text-m)}

/* â”€â”€ ã‚¿ã‚° & é€šçŸ¥ â”€â”€ */
.tags{display:flex;flex-wrap:wrap;gap:8px;margin:16px 0}
.tag{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:14px;font-weight:700;border:1.5px solid var(--border)}
.tag .offline{opacity:.4;font-size:11px;margin-left:4px}
.notice{border-radius:14px;padding:16px 20px;font-size:14px;line-height:1.7;background:var(--accent-light);color:var(--text-l);border:1.5px solid rgba(245,166,35,0.15)}
.room-code{font-size:48px;font-weight:900;letter-spacing:12px;text-align:center;font-family:'Courier New',monospace;color:var(--accent);padding:16px;background:var(--accent-light);border:2px dashed rgba(245,166,35,0.3);border-radius:16px}

/* â”€â”€ ã‚­ãƒ£ãƒ³ãƒã‚¹ & ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ â”€â”€ */
.canvas-wrap{border-radius:16px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.06);border:1.5px solid var(--border);background:#fffef5;width:100%}
#drawCanvas{width:100%;height:400px;cursor:crosshair;touch-action:none;display:block}
.toolbar{display:flex;flex-wrap:wrap;gap:6px;align-items:center;justify-content:center;padding:10px;border-radius:14px;background:var(--soft)}
.tdiv{width:1px;height:28px;background:var(--border)}
.cbtn{width:28px;height:28px;border-radius:50%;border:3px solid #ccc;cursor:pointer;transition:transform .12s}.cbtn.on{border-color:var(--primary);transform:scale(1.2)}
.sbtn{width:32px;height:32px;border-radius:10px;border:2px solid var(--border);background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}.sbtn.on{border-color:var(--primary);background:var(--primary-light)}
.tbtn{padding:6px 10px;border-radius:10px;border:2px solid var(--border);background:#fff;cursor:pointer;font-size:16px}.tbtn.on{border-color:var(--primary);background:var(--primary-light)}

/* â”€â”€ ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ â”€â”€ */
.prog{width:100%;height:8px;background:var(--border);border-radius:4px;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--accent));border-radius:4px;transition:width .5s}

/* â”€â”€ ç´™èŠå±…ï¼ˆçµæœç™ºè¡¨ï¼‰ â”€â”€ */
.kami{position:fixed;inset:0;z-index:1000;background:var(--bg);display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px}
.kami-frame{width:100%;max-width:720px;background:linear-gradient(145deg,#d4c4a8,#e8dcc8 20%,#c4b498 40%,#ddd0b8 60%,#c8bc98 80%,#d4c4a8);border-radius:12px;padding:20px;box-shadow:0 4px 20px rgba(0,0,0,.08)}
.kami-stage{background:#fffef5;border-radius:8px;min-height:320px;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden}
.kami-slide{width:100%;text-align:center;padding:24px;animation:kamiSlide .5s ease-out}
.kami-narr{color:var(--text-l);text-align:center;margin-top:14px;font-size:16px;font-weight:700}
.kami-dots{display:flex;gap:6px;justify-content:center;margin-top:10px}
.kami-dot{width:10px;height:10px;border-radius:50%;background:var(--border);transition:all .3s}.kami-dot.on{background:var(--accent);transform:scale(1.3)}.kami-dot.past{background:var(--text-m)}
.kami-ctrl{display:flex;gap:12px;margin-top:14px;width:100%;max-width:720px}.kami-ctrl .btn{flex:1}
.kami-label{font-size:14px;color:var(--text-l);margin-bottom:10px;font-weight:700}
.kami-word{font-size:38px;font-weight:900;font-family:'Hachi Maru Pop',cursive;color:var(--text)}
.kami-img img{max-width:100%;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.06)}

/* â”€â”€ çµæœã¾ã¨ã‚ã‚«ãƒ¼ãƒ‰ â”€â”€ */
.sum-card{border-radius:14px;overflow:hidden;border:1.5px solid var(--border);background:#fff;margin-bottom:10px}
.sum-h{padding:8px 14px;display:flex;align-items:center;gap:8px;font-size:13px;font-weight:700}
.sum-h.t{background:var(--accent-light);color:var(--accent)}
.sum-h.d{background:var(--primary-light);color:var(--primary)}
.sum-h.g{background:linear-gradient(135deg,#e8f8f0,#d4f0e0);color:var(--success)}
.sum-b{padding:14px;text-align:center}.sum-b img{max-width:100%;border-radius:8px}
.sum-w{font-size:26px;font-weight:900;font-family:'Hachi Maru Pop',cursive;color:var(--text)}
.res-b{text-align:center;padding:16px;border-radius:14px;color:#fff;font-size:18px;font-weight:900;margin-bottom:14px}
.res-b.ok{background:var(--success)}.res-b.ng{background:var(--danger)}

/* â”€â”€ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ & ãƒˆãƒ¼ã‚¹ãƒˆ â”€â”€ */
.confetti{position:fixed;top:-20px;width:10px;height:10px;border-radius:2px;animation:confetti 2.5s ease-in forwards;pointer-events:none}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--primary);color:#fff;padding:10px 20px;border-radius:12px;font-size:14px;font-weight:700;z-index:2000;animation:slideUp .3s ease-out;pointer-events:none}

/* â”€â”€ å…±æœ‰ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ â”€â”€ */
.share-area{display:flex;flex-direction:column;gap:8px;margin-top:16px;width:100%}
.btn-share{width:100%;padding:14px;border-radius:var(--r);font-size:18px;font-weight:bold;color:#fff;
  background:var(--primary);display:flex;align-items:center;justify-content:center;gap:8px;
  position:relative;overflow:hidden;border:none;cursor:pointer;font-family:'Zen Maru Gothic',sans-serif}
.btn-share:hover{filter:brightness(1.1)}.btn-share:disabled{opacity:.5;cursor:not-allowed;filter:none}
.btn-share::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.15) 0%,transparent 60%);pointer-events:none}
.share-row{display:flex;gap:8px;width:100%}
.btn-gmail{flex:1;padding:12px;border-radius:var(--r);font-size:16px;font-weight:bold;color:#fff;
  background:linear-gradient(135deg,#ea4335,#d93025);display:flex;align-items:center;justify-content:center;gap:6px;border:none;cursor:pointer;font-family:'Zen Maru Gothic',sans-serif}
.btn-gmail:hover{filter:brightness(1.1)}
.sum-nav{display:flex;gap:12px;justify-content:center;align-items:center;margin:16px 0}
.sum-page{color:var(--primary);font-size:16px;font-weight:700}
.btn-download{width:100%;padding:11px;border-radius:var(--r);font-size:15px;font-weight:600;
  color:var(--primary);background:var(--primary-light);border:1.5px solid rgba(139,106,174,0.2);
  display:flex;align-items:center;justify-content:center;gap:6px;cursor:pointer;font-family:'Zen Maru Gothic',sans-serif}
.btn-download:hover{background:rgba(139,106,174,.15)}
.share-toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);
  background:var(--success);color:#fff;padding:12px 24px;border-radius:14px;font-weight:bold;
  font-size:15px;opacity:0;transition:all .4s cubic-bezier(.4,0,.2,1);z-index:2001;
  box-shadow:0 4px 16px rgba(92,184,122,.3);pointer-events:none;font-family:'Zen Maru Gothic',sans-serif}
.share-toast.show{transform:translateX(-50%) translateY(0);opacity:1}

/* â”€â”€ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ & ã‚¹ãƒ†ã‚£ãƒƒã‚«ãƒ¼ â”€â”€ */
.chara{display:inline-block;object-fit:contain;pointer-events:none}
.bg-sticker{position:absolute;pointer-events:none;z-index:0;object-fit:contain}

/* â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€ */
.flex-r{display:flex;gap:8px;width:100%}.flex-c{display:flex;flex-direction:column;gap:12px;width:100%}
.tc{text-align:center}.mt{margin-top:12px}.mb{margin-bottom:12px}

/* â”€â”€ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ â”€â”€ */
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.85)}to{opacity:1;transform:scale(1)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
@keyframes wiggle{0%,100%{transform:rotate(-3deg)}50%{transform:rotate(3deg)}}
@keyframes confetti{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(500px) rotate(720deg);opacity:0}}
@keyframes kamiSlide{from{opacity:0;transform:translateX(50px)}to{opacity:1;transform:translateX(0)}}

/* â”€â”€ ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– â”€â”€ */
@media(max-width:520px){.card{padding:20px}h1{font-size:28px}.room-code{font-size:36px;letter-spacing:8px}#drawCanvas{height:300px}}
</style>
</head>
<body>
<div class="app">
  <!-- â”€â”€ ãƒ›ãƒ¼ãƒ ç”»é¢ â”€â”€ -->
  <div class="screen active" id="s-home">
    <div style="height:24px"></div>
    <div class="card flex-c tc" style="gap:20px">
      <div>
        <img class="chara" data-chara="cheer" src="images/chara-cheer.png" style="width:130px;margin-bottom:8px">
        <h1>Theç”»ä¼¯</h1>
        <p class="sub mt">ãŠçµµæãä¼è¨€ã‚²ãƒ¼ãƒ </p>
      </div>
      <div class="notice" style="text-align:left"><p style="font-weight:700;font-size:16px;margin-bottom:8px">ğŸ“– éŠã³æ–¹</p><p>â‘  å…¨å“¡ãŒãŠé¡Œã‚’å‡ºã™ ğŸ“</p><p>â‘¡ ä»–ã®äººã®ãŠé¡Œã«çµµã‚’æã ğŸ–Œï¸</p><p>â‘¢ ä»–ã®äººã®çµµã‚’è¦‹ã¦ç­”ãˆã‚’å½“ã¦ã‚‹ ğŸ¤”</p><p>â‘£ å…¨å“¡å›ã£ãŸã‚‰çµæœç™ºè¡¨ï¼ğŸ˜‚</p></div>
      <div class="flex-c" style="gap:12px">
        <input class="inp" id="i-name" placeholder="ã‚ãªãŸã®åå‰" maxlength="10">
        <button class="btn btn-p" onclick="doCreate()">ğŸ  ãƒ«ãƒ¼ãƒ ã‚’ä½œã‚‹</button>
        <div class="flex-r"><input class="inp" id="i-code" placeholder="ã‚³ãƒ¼ãƒ‰" maxlength="4" style="text-transform:uppercase;letter-spacing:4px;text-align:center;flex:1"><button class="btn btn-s" onclick="doJoin()" style="width:auto;padding:14px 24px">å‚åŠ </button></div>
      </div>
      <p id="home-err" style="color:var(--danger);font-size:14px;display:none"></p>
    </div>
  </div>

  <!-- â”€â”€ ãƒ­ãƒ“ãƒ¼ â”€â”€ -->
  <div class="screen" id="s-lobby"><div class="card flex-c" style="gap:16px">
    <h2>ğŸ® ãƒ­ãƒ“ãƒ¼</h2>
    <div class="tc">
      <img class="chara" data-chara="together" src="images/chara-together.png" style="width:110px;margin-bottom:8px">
      <p class="sub mb">ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰</p><div class="room-code" id="l-code"></div><p class="sub mt">åŒã˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰å‚åŠ </p>
    </div>
    <div><p style="font-weight:700;font-size:15px;margin-bottom:8px">ğŸ‘¥ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ <span id="l-count"></span></p><div class="tags" id="l-players"></div></div>
    <div id="l-host" style="display:none"><button class="btn btn-p" onclick="doStart()" id="l-startbtn">ğŸš€ ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</button><p id="l-msg" class="sub mt"></p></div>
    <div id="l-wait" style="display:none"><div class="notice tc">ãƒ›ã‚¹ãƒˆãŒã‚²ãƒ¼ãƒ é–‹å§‹ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</div></div>
  </div></div>

  <!-- â”€â”€ ãŠé¡Œå…¥åŠ› â”€â”€ -->
  <div class="screen" id="s-topic"><div class="card flex-c tc" style="gap:20px">
    <div>
      <img class="chara" data-chara="cheer" src="images/chara-cheer.png" style="width:80px;margin-bottom:4px">
      <h2>ãŠé¡Œã‚’å…¥åŠ›ï¼</h2><p class="sub">ã¿ã‚“ãªã«ä¼ãˆã‚‹è¨€è‘‰ã‚’æ±ºã‚ã‚ˆã†</p>
    </div>
    <input class="inp" id="i-topic" placeholder="ä¾‹ï¼šå®‡å®™é£›è¡Œå£«ã€ãŸã“ç„¼ã..." maxlength="20" style="text-align:center;font-size:22px">
    <button class="btn btn-p" onclick="doTopic()">ğŸ¯ æ±ºå®šï¼</button>
  </div></div>

  <!-- â”€â”€ ãŠé¡Œå¾…æ©Ÿ â”€â”€ -->
  <div class="screen" id="s-topic-wait"><div class="card flex-c tc" style="gap:16px">
    <img class="chara" data-chara="sad" src="images/chara-sad.png" style="width:80px;animation:float 2.5s ease-in-out infinite">
    <h2>ãŠé¡Œã‚’æå‡ºã—ã¾ã—ãŸï¼</h2><p class="sub">å…¨å“¡ãŒæå‡ºã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
    <div style="padding:16px"><div class="prog"><div class="prog-fill" id="topic-prog"></div></div><p class="sub mt" id="topic-prog-t"></p></div>
  </div></div>

  <!-- â”€â”€ ãŠçµµæã â”€â”€ -->
  <div class="screen" id="s-draw"><div class="card flex-c" style="gap:8px;padding:16px">
    <div class="tc">
      <p style="font-size:13px;color:var(--text-l)" id="d-info"></p>
      <div style="display:inline-flex;align-items:center;gap:10px;background:var(--accent-light);border:1.5px solid rgba(245,166,35,0.2);border-radius:14px;padding:8px 16px;margin:6px 0">
        <img class="chara" data-chara="peek" src="images/chara-peek.png" style="width:50px">
        <span id="d-prompt" style="font-size:20px;font-weight:900;font-family:'Hachi Maru Pop',cursive;color:var(--accent)"></span>
      </div>
    </div>
    <div class="canvas-wrap"><canvas id="drawCanvas"></canvas></div>
    <div class="toolbar" id="toolbar"></div>
    <button class="btn btn-ok" onclick="doSubmitDraw()">âœ… æã‘ãŸï¼æå‡ºã™ã‚‹</button>
  </div></div>

  <!-- â”€â”€ å›ç­” â”€â”€ -->
  <div class="screen" id="s-guess"><div class="card flex-c" style="gap:14px">
    <div style="display:flex;align-items:center;justify-content:center;gap:10px">
      <img class="chara" data-chara="sad" src="images/chara-sad.png" style="width:60px">
      <div class="tc"><p style="font-size:13px;color:var(--text-l)" id="g-info"></p><p style="font-weight:700;font-size:18px;margin-top:4px">ã“ã®çµµã¯ä½•ï¼ŸğŸ¤”</p></div>
    </div>
    <div style="border-radius:16px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.06);border:1.5px solid var(--border)"><img id="g-image" style="width:100%;display:block" alt="çµµ"></div>
    <div class="flex-r"><input class="inp" id="i-guess" placeholder="ç­”ãˆã‚’å…¥åŠ›..." maxlength="20" style="flex:1"><button class="btn btn-ok" onclick="doSubmitGuess()" style="width:auto;padding:14px 24px">ğŸ“</button></div>
  </div></div>

  <!-- â”€â”€ å¾…æ©Ÿä¸­ â”€â”€ -->
  <div class="screen" id="s-waiting"><div class="card flex-c tc" style="gap:16px">
    <img class="chara" data-chara="sad" src="images/chara-sad.png" style="width:100px;animation:float 2.5s ease-in-out infinite">
    <h2>æå‡ºå®Œäº†ï¼</h2><p class="sub">ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
    <div style="padding:16px"><div class="prog"><div class="prog-fill" id="round-prog"></div></div><p class="sub mt" id="round-prog-t"></p></div>
  </div></div>

  <!-- â”€â”€ å…¨å“¡å®Œäº† â”€â”€ -->
  <div class="screen" id="s-complete"><div class="card flex-c tc" style="gap:20px">
    <img class="chara" data-chara="together" src="images/chara-together.png" style="width:110px;animation:wiggle 1.5s ease-in-out infinite">
    <h2>å…¨å“¡å®Œäº†ï¼</h2><p class="sub">ã„ã‚ˆã„ã‚ˆçµæœç™ºè¡¨ã§ã™ï¼</p>
    <div id="c-host" style="display:none"><button class="btn btn-p" onclick="socket.emit('startReveal')">ğŸ­ çµæœç™ºè¡¨ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button></div>
    <div id="c-wait" style="display:none"><div class="notice tc">ãƒ›ã‚¹ãƒˆãŒçµæœç™ºè¡¨ã‚’å§‹ã‚ã¾ã™...</div></div>
  </div></div>
</div>

<!-- â”€â”€ ç´™èŠå±…ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ â”€â”€ -->
<div class="kami" id="kami">
  <div class="kami-frame"><div class="kami-stage" id="kami-stage"><div class="kami-slide" id="kami-slide"></div></div></div>
  <div class="kami-narr" id="kami-narr"></div>
  <div class="kami-dots" id="kami-dots"></div>
  <div class="kami-ctrl" id="kami-ctrl"></div>
</div>

<!-- â”€â”€ çµæœã¾ã¨ã‚ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ â”€â”€ -->
<div class="kami" id="summary" style="overflow-y:auto"><div style="width:100%;max-width:720px;padding:20px" id="sum-inner"></div></div>
<div class="share-toast" id="shareToast"></div>

<script>
// â”€â”€ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã®ç™½èƒŒæ™¯é™¤å» â”€â”€
var charaCache={};
function removeWhiteBg(imgSrc,callback){
  if(charaCache[imgSrc]){callback(charaCache[imgSrc]);return;}
  var img=new Image();
  img.crossOrigin='anonymous';
  img.onload=function(){
    var c=document.createElement('canvas');c.width=img.width;c.height=img.height;
    var ctx=c.getContext('2d');ctx.drawImage(img,0,0);
    var d=ctx.getImageData(0,0,c.width,c.height),p=d.data;
    for(var i=0;i<p.length;i+=4){
      var r=p[i],g=p[i+1],b=p[i+2];
      var brightness=(r+g+b)/3;
      var maxC=Math.max(r,g,b),minC=Math.min(r,g,b);
      var saturation=maxC>0?(maxC-minC)/maxC:0;
      if(brightness>235&&saturation<0.08){p[i+3]=0;}
      else if(brightness>215&&saturation<0.12){var fade=(brightness-215)/20;p[i+3]=Math.round(p[i+3]*(1-fade));}
    }
    ctx.putImageData(d,0,0);
    var result=c.toDataURL('image/png');
    charaCache[imgSrc]=result;
    callback(result);
  };
  img.onerror=function(){};
  img.src=imgSrc;
}

function processCharaImages(){
  var imgs=document.querySelectorAll('img[data-chara]:not([data-processed])');
  for(var i=0;i<imgs.length;i++){
    (function(img){
      img.setAttribute('data-processed','1');
      removeWhiteBg(img.src,function(dataUrl){img.src=dataUrl;});
    })(imgs[i]);
  }
}

// â”€â”€ ã‚¹ãƒ†ã‚£ãƒƒã‚«ãƒ¼åˆ‡ã‚Šå‡ºã— & ç™½é™¤å» â”€â”€
var stickerCache={};
function cropAndCleanSticker(sheetSrc,col,row,callback){
  var key=sheetSrc+'_'+col+'_'+row;
  if(stickerCache[key]){callback(stickerCache[key]);return;}
  var img=new Image();
  img.crossOrigin='anonymous';
  img.onload=function(){
    var cellW=img.width/4,cellH=img.height/3;
    var c=document.createElement('canvas');c.width=cellW;c.height=cellH;
    var ctx=c.getContext('2d');
    ctx.drawImage(img,col*cellW,row*cellH,cellW,cellH,0,0,cellW,cellH);
    var d=ctx.getImageData(0,0,c.width,c.height),p=d.data;
    for(var i=0;i<p.length;i+=4){
      var r=p[i],g=p[i+1],b=p[i+2];
      var brightness=(r+g+b)/3;
      var maxC=Math.max(r,g,b),minC=Math.min(r,g,b);
      var saturation=maxC>0?(maxC-minC)/maxC:0;
      if(brightness>235&&saturation<0.08){p[i+3]=0;}
      else if(brightness>215&&saturation<0.12){var fade=(brightness-215)/20;p[i+3]=Math.round(p[i+3]*(1-fade));}
    }
    ctx.putImageData(d,0,0);
    var result=c.toDataURL('image/png');
    stickerCache[key]=result;
    callback(result);
  };
  img.onerror=function(){};
  img.src=sheetSrc;
}

function renderScatteredStickers(){
  var appEl=document.querySelector('.app');
  var defs=[
    {sheet:'images/sticker-sheet1.jpg',col:0,row:0,size:65,opacity:0.15,top:60,left:-5,rotate:-12},
    {sheet:'images/sticker-sheet2.jpg',col:1,row:0,size:55,opacity:0.13,top:180,right:-3,rotate:8},
    {sheet:'images/sticker-sheet1.jpg',col:2,row:1,size:50,opacity:0.14,top:350,left:0,rotate:-6},
    {sheet:'images/sticker-sheet2.jpg',col:3,row:2,size:60,opacity:0.16,top:500,right:0,rotate:15},
    {sheet:'images/sticker-sheet1.jpg',col:1,row:2,size:48,opacity:0.12,top:650,left:5,rotate:-10},
    {sheet:'images/sticker-sheet2.jpg',col:0,row:1,size:55,opacity:0.15,top:800,right:5,rotate:5},
    {sheet:'images/sticker-sheet1.jpg',col:3,row:0,size:52,opacity:0.13,top:420,right:-2,rotate:12},
    {sheet:'images/sticker-sheet2.jpg',col:2,row:2,size:58,opacity:0.14,top:250,left:-4,rotate:-8}
  ];
  defs.forEach(function(def){
    cropAndCleanSticker(def.sheet,def.col,def.row,function(dataUrl){
      var el=document.createElement('img');el.className='bg-sticker';el.src=dataUrl;
      var pos='position:absolute;pointer-events:none;z-index:0;width:'+def.size+'px;height:'+def.size+'px;object-fit:contain;opacity:'+def.opacity+';top:'+def.top+'px;';
      if(def.left!=null)pos+='left:'+def.left+'px;';
      if(def.right!=null)pos+='right:'+def.right+'px;';
      if(def.rotate)pos+='transform:rotate('+def.rotate+'deg);';
      el.style.cssText=pos;
      appEl.appendChild(el);
    });
  });
}

// === Session ===
var SID_KEY='telestrations_sid';
function getSessionId(){var s=sessionStorage.getItem(SID_KEY);if(!s){s='s_'+Math.random().toString(36).substr(2,12)+'_'+Date.now();sessionStorage.setItem(SID_KEY,s);}return s;}
var sessionId=getSessionId();

var socket=io({reconnection:true,reconnectionAttempts:Infinity,reconnectionDelay:1000,reconnectionDelayMax:5000});
var myName='',roomCode='',isHost=false;
var canvas,ctx,drawing=false,lastPos=null,curColor='#1a1a2e',curSize=6,eraser=false,hist=[];
var COLORS=['#1a1a2e','#e74c3c','#e67e22','#f1c40f','#2ecc71','#3498db','#9b59b6','#e91e8f','#795548','#ffffff'];
var SIZES=[3,6,12,20];

// === Reconnect on socket reconnect ===
socket.on('connect',function(){
  if(roomCode){
    socket.emit('reconnectSession',sessionId,function(r){
      if(r.success){myName=r.name;roomCode=r.code;toast('â™»ï¸ å†æ¥ç¶šã—ã¾ã—ãŸ');}
    });
  }
});

function show(id){document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active')});var e=document.getElementById('s-'+id);if(e)e.classList.add('active');document.getElementById('kami').style.display='none';document.getElementById('summary').style.display='none';processCharaImages();}
function err(m){var e=document.getElementById('home-err');e.textContent=m;e.style.display='block';setTimeout(function(){e.style.display='none'},4000);}
function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function toast(msg){var t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(function(){t.remove()},3000);}

// === Home ===
function doCreate(){var n=document.getElementById('i-name').value.trim();if(!n)return err('åå‰ã‚’å…¥åŠ›');myName=n;socket.emit('createRoom',{name:n,sessionId:sessionId},function(r){if(r.success)roomCode=r.code;else err(r.error)});}
function doJoin(){var n=document.getElementById('i-name').value.trim(),c=document.getElementById('i-code').value.trim().toUpperCase();if(!n)return err('åå‰ã‚’å…¥åŠ›');if(!c)return err('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›');myName=n;socket.emit('joinRoom',{name:n,code:c,sessionId:sessionId},function(r){if(r.success)roomCode=r.code;else err(r.error)});}

// === Lobby ===
socket.on('roomState',function(d){
  roomCode=d.code;isHost=d.isHost;
  if(d.phase==='lobby'){show('lobby');document.getElementById('l-code').textContent=d.code;
    document.getElementById('l-count').textContent='('+d.players.length+'/8)';
    var c=document.getElementById('l-players');c.innerHTML='';
    var ic=['ğŸŸ¡','ğŸ”´','ğŸ”µ','ğŸŸ¢','ğŸŸ£','ğŸŸ ','âšª','ğŸŸ¤'];
    d.players.forEach(function(p,i){var t=document.createElement('div');t.className='tag';t.style.background='hsl('+(i*45)+',50%,93%)';t.style.borderColor='hsl('+(i*45)+',40%,82%)';t.style.opacity=p.online?1:.5;t.innerHTML='<span>'+ic[i]+'</span><span>'+p.name+'</span>'+(p.name===d.hostName?'<span style="font-size:12px">ğŸ‘‘</span>':'')+(p.online?'':'<span class="offline">âš«</span>');c.appendChild(t);});
    document.getElementById('l-host').style.display=isHost?'block':'none';
    document.getElementById('l-wait').style.display=isHost?'none':'block';
    document.getElementById('l-startbtn').disabled=d.players.length<3;
    document.getElementById('l-msg').textContent=d.players.length<3?'ã‚ã¨'+(3-d.players.length)+'äººå¿…è¦ã§ã™':d.players.length+'äººã§éŠã³ã¾ã™';
  }
});
function doStart(){socket.emit('startGame',function(r){if(!r.success)alert(r.error)});}

// === Topics ===
socket.on('enterTopic',function(){show('topic');document.getElementById('i-topic').value='';document.getElementById('i-topic').focus();});
function doTopic(){var t=document.getElementById('i-topic').value.trim();if(!t)return;socket.emit('submitTopic',t);}
socket.on('topicSubmitted',function(){show('topic-wait');});
socket.on('topicProgress',function(d){document.getElementById('topic-prog').style.width=Math.round(d.submitted/d.total*100)+'%';document.getElementById('topic-prog-t').textContent=d.submitted+'/'+d.total+' äººãŒæå‡º';});

// === Playing ===
socket.on('yourTurn',function(d){
  if(d.type==='draw'){show('draw');document.getElementById('d-info').textContent='ãƒ©ã‚¦ãƒ³ãƒ‰ '+d.roundNumber+'/'+d.totalRounds+(d.promptType==='topic'?' â€” ãŠé¡Œã‚’çµµã«ã—ã¦ã­':' â€” å›ç­”ã‚’çµµã«ã—ã¦ã­');document.getElementById('d-prompt').textContent='ã€Œ'+d.prompt+'ã€';initCanvas();}
  else{show('guess');document.getElementById('g-info').textContent='ãƒ©ã‚¦ãƒ³ãƒ‰ '+d.roundNumber+'/'+d.totalRounds;document.getElementById('g-image').src=d.prompt;document.getElementById('i-guess').value='';setTimeout(function(){document.getElementById('i-guess').focus()},100);}
});
function doSubmitDraw(){if(!canvas)return;socket.emit('submitDrawing',canvas.toDataURL('image/png'));}
function doSubmitGuess(){var v=document.getElementById('i-guess').value.trim();if(!v)return;socket.emit('submitGuess',v);}
socket.on('waitingForOthers',function(){show('waiting');});
socket.on('roundProgress',function(d){document.getElementById('round-prog').style.width=Math.round(d.submitted/d.total*100)+'%';document.getElementById('round-prog-t').textContent=d.submitted+'/'+d.total+' äººãŒæå‡º';});

// === Complete ===
socket.on('allChainsComplete',function(d){show('complete');isHost=d.isHost;document.getElementById('c-host').style.display=d.isHost?'block':'none';document.getElementById('c-wait').style.display=d.isHost?'none':'block';});

// === Kamishibai ===
var kTotal=0,kCur=0;

socket.on('startChainReveal',function(d){
  kTotal=d.totalSteps;kCur=0;
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active')});
  document.getElementById('kami').style.display='flex';document.getElementById('summary').style.display='none';
  var e=d.firstEntry;
  document.getElementById('kami-slide').innerHTML='<div style="animation:kamiSlide .5s ease-out"><p class="kami-label">ğŸ“Œ '+esc(e.playerName)+' ã®ãŠé¡Œ</p><p class="kami-word" style="font-size:44px">'+esc(e.content)+'</p></div>';
  document.getElementById('kami-narr').textContent=(d.chainIdx+1)+'/'+d.totalChains+' â€” '+esc(e.playerName)+'ã•ã‚“ã®ãŠé¡Œã€Œ'+e.content+'ã€ï¼';
  buildDots();
  document.getElementById('kami-ctrl').innerHTML=d.isHost?'<button class="btn btn-p" onclick="socket.emit(\'nextRevealStep\')">ğŸ‘† æ¬¡ã‚’ã‚ãã‚‹ï¼</button>':'';
});

socket.on('revealStep',function(d){
  kCur=d.stepIdx;buildDots();
  var sl=document.getElementById('kami-slide'),nr=document.getElementById('kami-narr'),ct=document.getElementById('kami-ctrl');
  var h='<div style="animation:kamiSlide .5s ease-out">';
  if(d.entry.type==='drawing'){h+='<p class="kami-label">ğŸ¨ '+esc(d.entry.playerName)+' ã•ã‚“ã®çµµ</p><div class="kami-img"><img src="'+d.entry.content+'" alt="drawing"></div>';nr.textContent=d.entry.playerName+'ã•ã‚“ãŒæãã¾ã—ãŸï¼';}
  else if(d.entry.type==='guess'){h+='<p class="kami-label">ğŸ’¬ '+esc(d.entry.playerName)+' ã•ã‚“ã®å›ç­”</p><p class="kami-word" style="color:var(--accent)">'+esc(d.entry.content)+'</p>';nr.textContent=d.entry.playerName+'ã•ã‚“ã®ç­”ãˆâ€¦ã€Œ'+d.entry.content+'ã€ï¼';}
  else{h+='<p class="kami-label">ğŸ“Œ '+esc(d.entry.playerName)+' ã®ãŠé¡Œ</p><p class="kami-word">'+esc(d.entry.content)+'</p>';nr.textContent='ãŠé¡Œã¯ã€Œ'+d.entry.content+'ã€ï¼';}
  h+='</div>';sl.innerHTML=h;ct.innerHTML='';
  if(d.isHost){
    if(!d.isLast)ct.innerHTML='<button class="btn btn-p" onclick="socket.emit(\'nextRevealStep\')">ğŸ‘† æ¬¡ã‚’ã‚ãã‚‹ï¼</button>';
    else{
      var o=d.originalTopic,l=d.entry.content;
      if(d.entry.type==='guess'){var m=l===o||l.indexOf(o)>=0||o.indexOf(l)>=0;nr.textContent=m?'ğŸ‰ ã™ã”ã„ï¼ã€Œ'+o+'ã€â†’ã€Œ'+l+'ã€ä¼ã‚ã£ãŸï¼':'ğŸ˜‚ ã€Œ'+o+'ã€ãŒã€Œ'+l+'ã€ã«å¤‰èº«ï¼';}
      ct.innerHTML='<button class="btn btn-p" onclick="socket.emit(\'nextRevealStep\')">ğŸ‘† æ¬¡ã¸</button>';
      spawnConfetti();
    }
  } else if(d.isLast&&d.entry.type==='guess'){var o2=d.originalTopic,l2=d.entry.content;var m2=l2===o2||l2.indexOf(o2)>=0||o2.indexOf(l2)>=0;nr.textContent=m2?'ğŸ‰ ã™ã”ã„ï¼ã€Œ'+o2+'ã€â†’ã€Œ'+l2+'ã€ä¼ã‚ã£ãŸï¼':'ğŸ˜‚ ã€Œ'+o2+'ã€ãŒã€Œ'+l2+'ã€ã«å¤‰èº«ï¼';}
});

socket.on('chainComplete',function(d){
  var nr=document.getElementById('kami-narr'),ct=document.getElementById('kami-ctrl');
  if(d.hasMoreChains){nr.textContent='æ¬¡ã®ãŠé¡Œã¸ï¼';ct.innerHTML=d.isHost?'<button class="btn btn-s" onclick="socket.emit(\'nextChain\')">ğŸ“– æ¬¡ã®ãŠé¡Œã¸ï¼</button>':'';}
  else{nr.textContent='å…¨å“¡åˆ†ã®ç™ºè¡¨ãŒçµ‚ã‚ã‚Šã¾ã—ãŸï¼';ct.innerHTML=d.isHost?'<button class="btn btn-s" onclick="socket.emit(\'nextChain\')">ğŸ“Š ã¾ã¨ã‚ã‚’è¦‹ã‚‹</button>':'';}
});

// === çµæœã¾ã¨ã‚ï¼ˆãƒšãƒ¼ã‚¸é€ã‚Šå¼ï¼‰ ===
socket.on('allRevealed',function(d){
  document.getElementById('kami').style.display='none';
  document.getElementById('summary').style.display='flex';
  shareLastChains=d.chains;
  summaryIsHost=d.isHost;
  isHost=d.isHost;
  currentChainIdx=0;
  renderSummaryPage(0);
});

function renderSummaryPage(idx){
  currentChainIdx=idx;
  var chains=shareLastChains;
  if(!chains||!chains[idx])return;
  var chain=chains[idx];
  var inner=document.getElementById('sum-inner');
  inner.innerHTML='';
  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
  var charaDiv=document.createElement('div');charaDiv.style.cssText='text-align:center;margin-bottom:8px';
  charaDiv.innerHTML='<img class="chara" data-chara="together" src="images/chara-together.png" style="width:90px">';
  inner.appendChild(charaDiv);
  // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒšãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ä»˜ãï¼‰
  var header=document.createElement('h2');
  header.style.cssText='color:var(--primary);font-size:24px;margin-bottom:8px;text-align:center';
  header.textContent='ğŸ“– '+chain.topicPlayerName+' ã®ãŠé¡Œ ('+(idx+1)+'/'+chains.length+')';
  inner.appendChild(header);
  // ä¸Šéƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
  var nav=document.createElement('div');nav.className='sum-nav';
  nav.innerHTML=(idx>0?'<button class="btn btn-g" onclick="renderSummaryPage('+(idx-1)+');window.scrollTo(0,0)" style="width:auto;padding:10px 20px;font-size:15px">â—€ å‰ã®ãŠé¡Œ</button>':'<div style="width:120px"></div>')
    +'<span class="sum-page">'+(idx+1)+' / '+chains.length+'</span>'
    +(idx<chains.length-1?'<button class="btn btn-s" onclick="renderSummaryPage('+(idx+1)+');window.scrollTo(0,0)" style="width:auto;padding:10px 20px;font-size:15px">æ¬¡ã®ãŠé¡Œ â–¶</button>':'<div style="width:120px"></div>');
  inner.appendChild(nav);
  // çµæœãƒãƒƒã‚¸
  var sec=document.createElement('div');sec.style.marginBottom='24px';
  var orig=chain.entries[0].content,last=chain.entries[chain.entries.length-1];
  if(last.type==='guess'){var match=last.content===orig||last.content.indexOf(orig)>=0||orig.indexOf(last.content)>=0;var b=document.createElement('div');b.className='res-b '+(match?'ok':'ng');b.textContent=match?'ğŸ‰ ä¼ã‚ã£ãŸï¼ã€Œ'+orig+'ã€':'ğŸ˜‚ ã€Œ'+orig+'ã€â†’ã€Œ'+last.content+'ã€';sec.appendChild(b);}
  // ã‚¨ãƒ³ãƒˆãƒªãƒ¼è¡¨ç¤º
  chain.entries.forEach(function(e,i){
    var card=document.createElement('div');card.className='sum-card';
    var hc=e.type==='topic'?'t':e.type==='drawing'?'d':'g';
    var ic=e.type==='topic'?'ğŸ“Œ':e.type==='drawing'?'ğŸ¨':'ğŸ’¬';
    var lb=e.type==='topic'?esc(e.playerName)+' ã®ãŠé¡Œ':e.type==='drawing'?esc(e.playerName)+' ãŒæã„ãŸ':esc(e.playerName)+' ã®å›ç­”';
    var bd=e.type==='drawing'?'<img src="'+e.content+'" style="max-width:100%">':'<span class="sum-w">'+esc(e.content)+'</span>';
    card.innerHTML='<div class="sum-h '+hc+'"><span>'+ic+'</span><span>'+lb+'</span></div><div class="sum-b">'+bd+'</div>';
    sec.appendChild(card);
    if(i<chain.entries.length-1){var a=document.createElement('div');a.style.cssText='text-align:center;font-size:20px;margin:4px 0;opacity:.3;color:var(--text-m)';a.textContent='â¬‡ï¸';sec.appendChild(a);}
  });
  inner.appendChild(sec);
  // ãƒ›ã‚¹ãƒˆãƒœã‚¿ãƒ³
  if(summaryIsHost){var btns=document.createElement('div');btns.className='flex-r';btns.style.marginTop='20px';btns.innerHTML='<button class="btn btn-p" onclick="socket.emit(\'newGame\')">ğŸ”„ ã‚‚ã†1å›ï¼</button><button class="btn btn-g" onclick="socket.emit(\'backToLobby\')" style="width:auto;padding:14px 20px">ğŸ </button>';inner.appendChild(btns);}
  // ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
  var nav2=document.createElement('div');nav2.className='sum-nav';
  nav2.innerHTML=nav.innerHTML;
  inner.appendChild(nav2);
  // å…±æœ‰ãƒœã‚¿ãƒ³
  var shareDiv=document.createElement('div');shareDiv.className='share-area';
  if(canNativeShare()){
    shareDiv.innerHTML='<button class="btn-share" id="btnShare" onclick="handleShareAll()">ğŸ“¤ ã“ã®çµæœã‚’å…±æœ‰ã™ã‚‹</button>';
  } else {
    shareDiv.innerHTML='<div class="share-row"><button class="btn-gmail" onclick="handleShareGmail()">âœ‰ Gmailã§å…±æœ‰</button><button class="btn-download" id="btnDownload" onclick="handleShareDownload()">ğŸ’¾ ç”»åƒã‚’ä¿å­˜</button></div>';
  }
  inner.appendChild(shareDiv);
  window.scrollTo(0,0);
  processCharaImages();
}

function buildDots(){var dots=document.getElementById('kami-dots');dots.innerHTML='';for(var i=0;i<kTotal;i++){var d=document.createElement('div');d.className='kami-dot'+(i===kCur?' on':i<kCur?' past':'');dots.appendChild(d);}}

// === Canvas ===
function initCanvas(){
  canvas=document.getElementById('drawCanvas');
  var wrap=canvas.parentElement;
  var newC=document.createElement('canvas');newC.id='drawCanvas';newC.style.cssText=canvas.style.cssText;
  wrap.replaceChild(newC,canvas);canvas=newC;
  ctx=canvas.getContext('2d');
  var w=wrap.getBoundingClientRect().width,h=parseInt(getComputedStyle(canvas).height);
  canvas.width=w*2;canvas.height=h*2;ctx.scale(2,2);
  ctx.fillStyle='#fffef5';ctx.fillRect(0,0,w,h);
  hist=[canvas.toDataURL()];curColor='#1a1a2e';curSize=6;eraser=false;
  buildToolbar();
  canvas.addEventListener('mousedown',onDown);canvas.addEventListener('mousemove',onMove);canvas.addEventListener('mouseup',onUp);canvas.addEventListener('mouseleave',onUp);
  canvas.addEventListener('touchstart',function(e){e.preventDefault();onDown(e)},{passive:false});
  canvas.addEventListener('touchmove',function(e){e.preventDefault();onMove(e)},{passive:false});
  canvas.addEventListener('touchend',function(e){e.preventDefault();onUp()},{passive:false});
}
function buildToolbar(){
  var tb=document.getElementById('toolbar');tb.innerHTML='';
  var cp=document.createElement('div');cp.style.cssText='display:flex;gap:4px;flex-wrap:wrap;justify-content:center';
  COLORS.forEach(function(c){var b=document.createElement('button');b.className='cbtn'+(c===curColor&&!eraser?' on':'');b.style.background=c;if(c==='#ffffff')b.style.boxShadow='inset 0 0 0 1px #ddd';b.onclick=function(){curColor=c;eraser=false;tb.querySelectorAll('.cbtn').forEach(function(x){x.classList.remove('on')});b.classList.add('on');document.getElementById('btn-er').classList.remove('on');};cp.appendChild(b);});
  tb.appendChild(cp);
  var d1=document.createElement('div');d1.className='tdiv';tb.appendChild(d1);
  var sp=document.createElement('div');sp.style.cssText='display:flex;gap:4px;align-items:center';
  SIZES.forEach(function(s){var b=document.createElement('button');b.className='sbtn'+(s===curSize?' on':'');var dot=document.createElement('div');dot.style.cssText='width:'+Math.min(s+2,18)+'px;height:'+Math.min(s+2,18)+'px;border-radius:50%;background:#333';b.appendChild(dot);b.onclick=function(){curSize=s;tb.querySelectorAll('.sbtn').forEach(function(x){x.classList.remove('on')});b.classList.add('on');};sp.appendChild(b);});
  tb.appendChild(sp);
  var d2=document.createElement('div');d2.className='tdiv';tb.appendChild(d2);
  var be=document.createElement('button');be.className='tbtn';be.id='btn-er';be.textContent='ğŸ§¹';be.onclick=function(){eraser=!eraser;be.classList.toggle('on',eraser);};tb.appendChild(be);
  var bu=document.createElement('button');bu.className='tbtn';bu.textContent='â†©ï¸';bu.onclick=function(){if(hist.length<2)return;hist.pop();var img=new Image();img.onload=function(){ctx.clearRect(0,0,canvas.width/2,canvas.height/2);ctx.drawImage(img,0,0,canvas.width/2,canvas.height/2);};img.src=hist[hist.length-1];};tb.appendChild(bu);
  var bc=document.createElement('button');bc.className='tbtn';bc.textContent='ğŸ—‘ï¸';bc.onclick=function(){ctx.fillStyle='#fffef5';ctx.fillRect(0,0,canvas.width/2,canvas.height/2);hist.push(canvas.toDataURL());};tb.appendChild(bc);
}
function getPos(e){var r=canvas.getBoundingClientRect();return{x:(e.touches?e.touches[0].clientX:e.clientX)-r.left,y:(e.touches?e.touches[0].clientY:e.clientY)-r.top};}
function dSz(){return eraser?curSize*3:curSize;}
function onDown(e){drawing=true;lastPos=getPos(e);ctx.beginPath();ctx.arc(lastPos.x,lastPos.y,dSz()/2,0,Math.PI*2);ctx.fillStyle=eraser?'#fffef5':curColor;ctx.fill();}
function onMove(e){if(!drawing)return;var p=getPos(e);ctx.beginPath();ctx.moveTo(lastPos.x,lastPos.y);ctx.lineTo(p.x,p.y);ctx.strokeStyle=eraser?'#fffef5':curColor;ctx.lineWidth=dSz();ctx.lineCap='round';ctx.lineJoin='round';ctx.stroke();lastPos=p;}
function onUp(){if(drawing){drawing=false;hist.push(canvas.toDataURL());if(hist.length>30)hist.shift();}}

// === Notifications ===
socket.on('playerWentOffline',function(d){toast('âš ï¸ '+d.name+' ãŒåˆ‡æ–­ ('+d.onlineCount+'äººæ¥ç¶šä¸­)');});
socket.on('playerReconnected',function(d){toast('âœ… '+d.name+' ãŒå†æ¥ç¶š');});
socket.on('playerDisconnected',function(d){alert(d.message);});

function spawnConfetti(){for(var i=0;i<25;i++){var c=document.createElement('div');c.className='confetti';c.style.left=Math.random()*100+'%';c.style.background='hsl('+Math.random()*360+',80%,60%)';c.style.animationDuration=(2+Math.random()*2)+'s';c.style.animationDelay=Math.random()*.5+'s';document.body.appendChild(c);setTimeout(function(){c.remove()},5000);}}
document.getElementById('i-name').addEventListener('keydown',function(e){if(e.key==='Enter'){var c=document.getElementById('i-code').value.trim();if(c)doJoin();else doCreate();}});
document.getElementById('i-code').addEventListener('keydown',function(e){if(e.key==='Enter')doJoin()});
document.getElementById('i-topic').addEventListener('keydown',function(e){if(e.key==='Enter')doTopic()});
document.getElementById('i-guess').addEventListener('keydown',function(e){if(e.key==='Enter')doSubmitGuess()});

// â”€â”€ å…±æœ‰æ©Ÿèƒ½ â”€â”€
var shareLastChains=null,currentChainIdx=0,summaryIsHost=false;

function canNativeShare(){return !!(navigator.share&&navigator.canShare);}

function generateShareImage(chains,callback){
  var totalToLoad=0,loadCount=0,images={};
  chains.forEach(function(chain,ci){
    chain.entries.forEach(function(e,ei){if(e.type==='drawing'&&e.content)totalToLoad++;});
  });
  if(totalToLoad===0){buildShareImage(chains,images,callback);return;}
  chains.forEach(function(chain,ci){
    chain.entries.forEach(function(e,ei){
      if(e.type==='drawing'&&e.content){
        (function(key,src){
          var img=new Image();
          img.onload=function(){images[key]=img;loadCount++;if(loadCount===totalToLoad)buildShareImage(chains,images,callback);};
          img.onerror=function(){loadCount++;if(loadCount===totalToLoad)buildShareImage(chains,images,callback);};
          img.src=src;
        })(ci+'_'+ei,e.content);
      }
    });
  });
}

function buildShareImage(chains,images,callback){
  var W=480,padding=24,entryGap=12,chainGap=32;
  var y=70;
  chains.forEach(function(chain){
    y+=36;
    chain.entries.forEach(function(e){
      y+=24;
      if(e.type==='drawing'){y+=(W-padding*2)*0.75+8;}else{y+=48;}
      y+=16+entryGap;
    });
    y+=chainGap;
  });
  y+=30;
  var H=y;
  var c=document.createElement('canvas');c.width=W*2;c.height=H*2;
  var ctx=c.getContext('2d');ctx.scale(2,2);
  // ã‚¯ãƒªãƒ¼ãƒ èƒŒæ™¯
  ctx.fillStyle='#faf7f2';ctx.fillRect(0,0,W,H);
  // ãƒ˜ãƒƒãƒ€ãƒ¼
  ctx.fillStyle='#8b6aae';ctx.font='bold 24px "Zen Maru Gothic",sans-serif';ctx.textAlign='center';
  ctx.fillText('Theç”»ä¼¯ çµæœ',W/2,40);
  ctx.fillStyle='#8a807a';ctx.font='13px "Zen Maru Gothic",sans-serif';ctx.fillText(chains.length+'äººåˆ†ã®ãƒã‚§ã‚¤ãƒ³',W/2,58);
  var curY=70;var contentW=W-padding*2;
  chains.forEach(function(chain,ci){
    ctx.fillStyle='#8b6aae';ctx.font='bold 16px "Zen Maru Gothic",sans-serif';ctx.textAlign='center';
    ctx.fillText('ğŸ¯ '+chain.topicPlayerName+' ã•ã‚“ã®ãŠé¡Œ',W/2,curY+20);curY+=36;
    chain.entries.forEach(function(e,ei){
      var label=e.type==='topic'?'ğŸ“Œ ãŠé¡Œ':e.type==='drawing'?'ğŸ¨ ãŠçµµæã':'ğŸ’¬ å›ç­”';
      ctx.fillStyle='#8a807a';ctx.font='11px "Zen Maru Gothic",sans-serif';ctx.textAlign='center';
      ctx.fillText(label+' â€” '+e.playerName,W/2,curY+14);curY+=24;
      if(e.type==='drawing'){
        var imgH=contentW*0.75;
        ctx.fillStyle='#fffef5';shareRoundRect(ctx,padding,curY,contentW,imgH,8);ctx.fill();
        ctx.strokeStyle='#e8e2d9';ctx.lineWidth=1;shareRoundRect(ctx,padding,curY,contentW,imgH,8);ctx.stroke();
        var key=ci+'_'+ei;
        if(images[key]){ctx.save();shareRoundRect(ctx,padding,curY,contentW,imgH,8);ctx.clip();ctx.drawImage(images[key],padding,curY,contentW,imgH);ctx.restore();}
        else{ctx.fillStyle='#b5ada6';ctx.font='14px sans-serif';ctx.fillText('(ç©ºç™½)',W/2,curY+imgH/2+5);}
        curY+=imgH+8;
      }else{
        ctx.fillStyle='rgba(139,106,174,0.08)';shareRoundRect(ctx,padding,curY,contentW,38,8);ctx.fill();
        ctx.fillStyle='#3d3535';ctx.font='bold 18px "Zen Maru Gothic",sans-serif';ctx.textAlign='center';
        ctx.fillText(e.content||'',W/2,curY+25);curY+=48;
      }
      curY+=16+entryGap;
    });
    curY+=chainGap;
  });
  ctx.fillStyle='#b5ada6';ctx.font='11px sans-serif';ctx.textAlign='center';
  ctx.fillText('Theç”»ä¼¯ â€” ãŠçµµæãä¼è¨€ã‚²ãƒ¼ãƒ ',W/2,H-12);
  c.toBlob(function(blob){callback(blob,c.toDataURL('image/png'));},'image/png');
}

function shareRoundRect(ctx,x,y,w,h,r){
  ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

function handleShareAll(){
  if(!shareLastChains)return;
  var btn=document.getElementById('btnShare');
  if(btn){btn.disabled=true;btn.textContent='â³ ç”»åƒã‚’ç”Ÿæˆä¸­...';}
  generateShareImage(shareLastChains,function(blob,dataUrl){
    if(btn){btn.disabled=false;btn.textContent='ğŸ“¤ ã“ã®çµæœã‚’å…±æœ‰ã™ã‚‹';}
    if(canNativeShare()){
      var file=new File([blob],'telestrations.png',{type:'image/png'});
      if(navigator.canShare({files:[file]})){navigator.share({files:[file],title:'Theç”»ä¼¯çµæœ'}).catch(function(){});return;}
    }
    shareDownloadImage(dataUrl);showShareToast('ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  });
}

function handleShareGmail(){
  if(!shareLastChains)return;
  var subject='Theç”»ä¼¯çµæœ';
  var body='Theç”»ä¼¯ã®çµæœ\n\n';
  shareLastChains.forEach(function(chain){
    body+='--- '+chain.topicPlayerName+' ã•ã‚“ã®ãŠé¡Œ ---\n';
    chain.entries.forEach(function(e){
      if(e.type==='drawing'){body+='ğŸ¨ '+e.playerName+' ãŒæã„ãŸ\n';}
      else{var label=e.type==='topic'?'ğŸ“Œ ãŠé¡Œ':'ğŸ’¬ å›ç­”';body+=label+'ï¼š'+e.content+' ('+e.playerName+')\n';}
    });
    body+='\n';
  });
  window.open('https://mail.google.com/mail/?view=cm&fs=1&su='+encodeURIComponent(subject)+'&body='+encodeURIComponent(body),'_blank');
}

function handleShareDownload(){
  if(!shareLastChains)return;
  var btn=document.getElementById('btnDownload');
  var origText=btn?btn.textContent:'';
  if(btn){btn.disabled=true;btn.textContent='â³ ç”»åƒã‚’ç”Ÿæˆä¸­...';}
  generateShareImage(shareLastChains,function(blob,dataUrl){
    if(btn){btn.disabled=false;btn.textContent=origText;}
    shareDownloadImage(dataUrl);showShareToast('âœ“ ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  });
}

function shareDownloadImage(dataUrl){
  var a=document.createElement('a');a.href=dataUrl;a.download='telestrations.png';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
}

function showShareToast(msg){
  var t=document.getElementById('shareToast');if(!t)return;
  t.textContent=msg;t.classList.add('show');
  setTimeout(function(){t.classList.remove('show');},2500);
}

// â”€â”€ åˆæœŸåŒ–ï¼šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‡¦ç† & ã‚¹ãƒ†ã‚£ãƒƒã‚«ãƒ¼æ•£ã‚Šã°ã‚ â”€â”€
processCharaImages();
renderScatteredStickers();
</script>
</body>
</html>
